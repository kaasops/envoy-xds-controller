# IMPORTANT: This file is used for standalone Docker container deployments only.
# When deploying via Helm, the configuration is generated from
# helm/charts/envoy-xds-controller/templates/ui/configmap.yaml
# which allows runtime configuration through values.yaml
#
# This file is baked into the Docker image at build time and used by entrypoint.sh
# for non-Helm deployments. It supports ${API_PROXY_PASS} and ${GRPC_API_PROXY_PASS}
# environment variable substitution via envsubst.

server {
    listen 8080;
    server_name _;
    root   /usr/share/nginx/html;

    # Increase buffer sizes for large JWT tokens (users with many OIDC groups)
    # Default is 4 8k, but tokens with 100+ groups can exceed 8KB
    # Each header line (e.g., Cookie with JWT) must fit in ONE buffer!
    # For 180 groups × 40 chars: JWT token ~15-25KB → need 32k per buffer
    large_client_header_buffers 8 32k;
    proxy_buffer_size 32k;
    proxy_buffers 8 32k;
    proxy_busy_buffers_size 64k;

    location = / {
        return 301 /nodeIDs;
    }
    location /nodeIDs {
        index  index.html index.htm;
        try_files $uri $uri/ /index.html; 
    }
    location /accessGroups {
        index  index.html index.htm;
        try_files $uri $uri/ /index.html;
    }
    location /callback {
        index  index.html index.htm;
        try_files $uri $uri/ /index.html;
    }
    location /api/v1 {
        proxy_pass ${API_PROXY_PASS};
    }
    location /grpc-api/ {
        proxy_pass ${GRPC_API_PROXY_PASS}/;
    }
}